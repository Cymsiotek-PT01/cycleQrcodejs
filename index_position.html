<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ko" lang="ko">
  <head>
    <title>Cross-Browser QRCode generator for Javascript</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,user-scalable=no"
    />
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="qrcode.js"></script>
  </head>
  <body>
    <!-- The main canvas -->
    <canvas
      id="mainCanvas"
      width="400"
      height="400"
      style="border: 1px solid black"
    ></canvas>

    <!-- A hidden div to hold the generated QR canvas -->
    <div id="tempQRDiv" style="display: none"></div>

    <script>
      window.onload = function () {
        var mainCanvas = document.getElementById("mainCanvas");
        var ctx = mainCanvas.getContext("2d");

        function drawCircle(x, y, radius, color) {
          ctx.beginPath();
          ctx.arc(x, y, radius, 0, 2 * Math.PI, false);
          ctx.strokeStyle = color;
          ctx.lineWidth = 10;
          ctx.stroke();
        }

        function clearOutsideCircle(x, y, radius) {
          var imageData = ctx.getImageData(
            0,
            0,
            mainCanvas.width,
            mainCanvas.height
          );
          var data = imageData.data;

          for (var i = 0; i < mainCanvas.width; i++) {
            for (var j = 0; j < mainCanvas.height; j++) {
              var dx = i - x;
              var dy = j - y;
              var distance = Math.sqrt(dx * dx + dy * dy);

              if (distance > radius) {
                var index = (i + j * mainCanvas.width) * 4;
                data[index + 3] = 0; // set alpha to 0 (transparent)
              }
            }
          }

          ctx.putImageData(imageData, 0, 0);
        }

        function renderQRAtPosition(qrData, sideLength) {
          mainCanvas.width = sideLength * 1.5;
          mainCanvas.height = sideLength * 1.5;
          x = sideLength / 4;
          y = sideLength / 4;
          var tempQRDiv = document.getElementById("tempQRDiv");

          // Create a new QRCode inside the tempQRDiv
          var qr = new QRCode(tempQRDiv, {
            text: qrData,
            width: sideLength,
            height: sideLength,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.L,
          });

          var pointWidth = 60;
          var scaleRate = sideLength / 200;
          var extracteY = pointWidth * scaleRate;
          var extracteHeight = 70 * scaleRate;
          var smallerQRRadius = 40 * scaleRate;
          var halfSide = sideLength / 2;
          var qrCircleRadius = sideLength / 2 + smallerQRRadius;

          // Give it some time to render
          setTimeout(function () {
            // The first child of tempQRDiv should be a canvas generated by qrcode.js
            var qrCanvas = tempQRDiv.children[0];
            ctx.drawImage(qrCanvas, x, y);
            // 擷取 QRCode 中的一部分 (不包括定位點)
            var extractedData = ctx.getImageData(
              x,
              y + extracteY,
              sideLength,
              extracteHeight
            );
            var extractedData2 = ctx.getImageData(
              x + extracteY,
              y,
              extracteHeight,
              sideLength
            );
            // 繪製該部分到原始 QRCode 的頂部和底部
            //上面
            ctx.putImageData(extractedData, x, y - extractedData.height);
            //下面
            ctx.putImageData(extractedData, x, y + sideLength);
            //左邊
            ctx.putImageData(extractedData2, x - extractedData2.width, y);
            //右邊
            ctx.putImageData(extractedData2, x + sideLength, y);

            // Draw a circle around everything
            drawCircle(halfSide + x, halfSide + y, qrCircleRadius, "#000000");
            // Optionally clear the temporary QR div to keep the DOM clean
            tempQRDiv.innerHTML = "";
            clearOutsideCircle(
              mainCanvas.width / 2,
              mainCanvas.height / 2,
              qrCircleRadius
            );
          }, 100); // Adjust this delay if necessary
        }

        renderQRAtPosition("https://www.example.com", 400);
      };
    </script>
  </body>
</html>
